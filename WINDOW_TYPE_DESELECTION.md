# 窗型取消选择功能

## 更新概述

在步骤2"选择窗型"中，支持再次点击已选中的窗型来取消选择，提供更灵活的交互体验。

## 更新时间

2025年11月6日

---

## 功能说明

### 原有行为

**之前的逻辑**：
```
点击窗型A → 选中窗型A → 自动进入步骤3
```

- 只能选择，不能取消
- 必须通过返回步骤重新选择

### 新增行为

**现在的逻辑**：
```
首次点击窗型A → 选中窗型A → 自动进入步骤3
返回步骤2
再次点击窗型A → 取消选择 → 显示Toast提示 → 停留在步骤2
```

- 支持取消选择
- 显示友好提示
- 可以重新选择其他窗型

---

## 交互流程

### 场景1：首次选择窗型

```
用户操作：点击窗型卡片（未选中状态）
    ↓
系统检查：selectedWindowType === null
    ↓
系统响应：
  1. 设置 selectedWindowType = 该窗型
  2. 卡片显示选中状态（蓝色边框 + ✓）
  3. 顶部显示"已选"徽章
  4. 自动调用 nextStage()
  5. 进入步骤3
    ↓
视觉反馈：
  - 卡片选中动画
  - 页面平滑切换
  - 步骤指示器更新
```

### 场景2：取消已选窗型

```
用户操作：再次点击已选中的窗型卡片
    ↓
系统检查：selectedWindowType.id === 点击窗型.id
    ↓
系统响应：
  1. 设置 selectedWindowType = null
  2. 卡片取消选中状态
  3. 隐藏"已选"徽章
  4. 显示Toast提示"已取消选择"
  5. 停留在步骤2
    ↓
视觉反馈：
  - 卡片恢复未选中样式
  - Toast从顶部滑入
  - 提示框重新显示
```

### 场景3：更换窗型

```
用户操作：点击其他未选中的窗型卡片
    ↓
系统检查：selectedWindowType.id !== 点击窗型.id
    ↓
系统响应：
  1. 旧窗型取消选中
  2. 新窗型被选中
  3. 更新"已选"徽章
  4. 自动进入步骤3
    ↓
视觉反馈：
  - 旧卡片取消选中动画
  - 新卡片选中动画
  - 页面平滑切换
```

---

## 代码实现

### 核心逻辑

```typescript
// 选择窗型（支持取消选择）
const handleWindowTypeSelect = (type: WindowType) => {
  // 如果点击的是已选中的窗型，则取消选择
  if (selectedWindowType?.id === type.id) {
    setSelectedWindowType(null)
    toast.info("已取消选择", {
      description: "您可以重新选择其他窗型",
    })
  } else {
    // 选择新窗型
    setSelectedWindowType(type)
    // 自动进入下一步
    nextStage()
  }
}
```

### 判断逻辑

```typescript
// 检查是否为同一个窗型
selectedWindowType?.id === type.id

// ✓ 使用 id 比较（推荐）
// ✗ 不使用 === 直接比较对象（会失败）
```

### Toast 提示

```typescript
toast.info("已取消选择", {
  description: "您可以重新选择其他窗型",
})
```

**特点**：
- 信息类型（info）
- 蓝色主题
- 简洁的标题
- 友好的描述

---

## UI 状态变化

### 窗型卡片状态循环

```
┌─────────────┐
│ 未选中状态  │
│             │
│   点击      │
│     ↓       │
│ 选中状态    │
│   ✓         │
│             │
│   再次点击  │
│     ↓       │
│ 未选中状态  │
└─────────────┘
```

### 详细状态对比

#### 状态1：未选中
```
┌─────────────┐
│             │
│   ┌─────┐   │
│   │     │   │
│   └─────┘   │
│             │
│   001矩形   │
│   1分格1    │
└─────────────┘
  灰色边框（1px）
  无选中标记
```

#### 状态2：选中
```
┌─────────────┐
│         ✓   │ ← 右上角对勾
│   ┌─────┐   │
│   │     │   │
│   └─────┘   │
│             │
│   001矩形   │
│   1分格1    │
└─────────────┘
  蓝色边框（2px）
  选中标记显示
```

#### 状态3：再次点击 → 返回未选中
```
┌─────────────┐
│             │
│   ┌─────┐   │
│   │     │   │
│   └─────┘   │
│             │
│   001矩形   │
│   1分格1    │
└─────────────┘
  灰色边框（1px）
  无选中标记
  + Toast提示
```

---

## Toast 提示设计

### 取消选择 Toast

```
┌─────────────────────────────────────────┐
│  ⓘ  已取消选择                      [×] │
│                                        │
│     您可以重新选择其他窗型              │
└─────────────────────────────────────────┘
```

**样式特点**：
- 蓝色渐变背景（info类型）
- 顶部居中显示
- 2秒自动消失
- 可手动关闭

### 与其他 Toast 对比

| Toast 类型 | 触发场景 | 标题 | 描述 |
|-----------|---------|------|------|
| **取消选择** | 点击已选窗型 | 已取消选择 | 您可以重新选择其他窗型 |
| **未选窗型** | 跳过步骤2 | 请先选择窗型 | 请在步骤2选择一个窗型后再继续下一步 |

---

## 使用场景

### 场景A：犹豫不决的用户

```
用户浏览窗型列表
  ↓
点击窗型A（看起来不错）
  ↓
进入步骤3预览
  ↓
觉得不合适，返回步骤2
  ↓
再次点击窗型A（取消选择）
  ↓
查看其他窗型
  ↓
点击窗型B（确定这个）
  ↓
进入步骤3
```

### 场景B：快速对比

```
步骤2：选择窗型
  ↓
点击窗型A → 进入步骤3查看
  ↓
返回步骤2
  ↓
点击窗型A（取消） → 清空选择
  ↓
点击窗型B → 进入步骤3查看
  ↓
返回步骤2
  ↓
点击窗型B（取消） → 清空选择
  ↓
点击窗型C → 进入步骤3（最终选择）
```

### 场景C：误操作恢复

```
用户正在浏览窗型
  ↓
不小心点击了某个窗型
  ↓
自动跳转到步骤3
  ↓
用户立即返回步骤2
  ↓
再次点击该窗型（取消误选）
  ↓
恢复到未选状态
  ↓
继续浏览其他窗型
```

---

## 交互细节

### 1. 点击动画

```css
/* 按下时缩小 */
.active\:scale-\[0\.98\] {
  transform: scale(0.98);
}

/* 过渡动画 */
.transition-all {
  transition: all 0.2s ease;
}
```

**效果**：
- 点击时卡片轻微缩小
- 松开时恢复原大小
- 提供清晰的触觉反馈

### 2. 边框变化

```
未选中 → 选中：
  border: 1px solid #e5e7eb
  ↓
  border: 2px solid #3b82f6

选中 → 未选中：
  border: 2px solid #3b82f6
  ↓
  border: 1px solid #e5e7eb
```

### 3. 对勾标记

```tsx
{selectedWindowType?.id === type.id && (
  <div className="absolute top-1 right-1 w-6 h-6 rounded-full bg-primary">
    <Check className="w-4 h-4 text-white" />
  </div>
)}
```

**特点**：
- 绝对定位在右上角
- 圆形蓝色背景
- 白色对勾图标
- 仅在选中时显示

---

## 用户体验优势

### 1. 更灵活的控制

```
✓ 用户可以随时取消选择
✓ 不需要刷新页面
✓ 操作直观简单
```

### 2. 减少错误操作

```
✓ 误点击可以快速撤销
✓ 避免强制跳转的困扰
✓ 提供二次确认的机会
```

### 3. 友好的反馈

```
✓ Toast提示清晰明了
✓ 视觉状态变化明显
✓ 操作结果可预期
```

### 4. 保持流畅

```
✓ 选择新窗型依然自动跳转
✓ 取消选择不会跳转
✓ 流程逻辑清晰
```

---

## 行为对比表

| 操作 | 之前 | 现在 |
|------|------|------|
| **首次点击未选窗型** | 选中 + 自动跳转 | 选中 + 自动跳转 ✓ |
| **点击已选窗型** | 不支持 ✗ | 取消选择 + Toast ✓ |
| **点击其他未选窗型** | 选中 + 自动跳转 | 选中 + 自动跳转 ✓ |
| **取消后状态** | N/A | 恢复未选状态 ✓ |

---

## 测试场景

### 功能测试

- [ ] **首次选择窗型**
  - 点击未选中窗型
  - 卡片变为选中状态
  - 自动进入步骤3

- [ ] **取消已选窗型**
  - 返回步骤2
  - 再次点击已选窗型
  - 显示"已取消选择" Toast
  - 卡片恢复未选中状态
  - 停留在步骤2

- [ ] **更换窗型**
  - 点击其他窗型
  - 旧窗型取消选中
  - 新窗型被选中
  - 自动进入步骤3

- [ ] **多次取消和选择**
  - 选择窗型A
  - 返回并取消
  - 选择窗型B
  - 返回并取消
  - 选择窗型C
  - 功能正常

### UI测试

- [ ] **Toast显示正确**
  - 取消时显示Toast
  - 样式为info类型
  - 2秒后自动消失
  - 可手动关闭

- [ ] **卡片状态正确**
  - 选中时显示✓标记
  - 取消时隐藏✓标记
  - 边框颜色正确切换
  - 动画过渡流畅

- [ ] **提示框联动**
  - 未选时显示蓝色提示框
  - 选中时隐藏提示框
  - 取消后重新显示提示框

### 边界测试

- [ ] **快速连续点击**
  - 快速点击同一窗型2次
  - 第1次：选中
  - 第2次：取消
  - 状态正确

- [ ] **在步骤3取消选择**
  - 无法在步骤3取消
  - 必须返回步骤2

- [ ] **网络延迟情况**
  - 点击响应及时
  - 状态更新正确

---

## 实现亮点

### 1. 简洁的逻辑

```typescript
if (selectedWindowType?.id === type.id) {
  // 取消选择
  setSelectedWindowType(null)
  toast.info("已取消选择", ...)
} else {
  // 选择新窗型
  setSelectedWindowType(type)
  nextStage()
}
```

**优点**：
- 逻辑清晰
- 易于理解
- 易于维护

### 2. 一致的交互

```
点击未选窗型 → 选中 + 跳转
点击已选窗型 → 取消 + 提示
点击其他窗型 → 切换 + 跳转
```

**规律**：
- 点击未选 = 选择
- 点击已选 = 取消
- 直观易懂

### 3. 可选的流程

```
用户可以：
✓ 直接选择并继续
✓ 取消后重新选择
✓ 多次对比后决定
✓ 任意时刻修改选择
```

---

## 相关文件

### 修改的文件

1. **app/design/page.tsx**
   - 修改 `handleWindowTypeSelect` 函数
   - 添加取消选择逻辑
   - 添加Toast提示

### 新增的文件

1. **WINDOW_TYPE_DESELECTION.md**
   - 功能说明文档
   - 使用指南

---

## 未来可能的优化

### 1. 确认对话框

对于已选择窗型的用户，在取消时可以显示确认对话框：

```typescript
if (selectedWindowType?.id === type.id) {
  if (confirm("确定要取消选择此窗型吗？")) {
    setSelectedWindowType(null)
    toast.info("已取消选择", ...)
  }
}
```

### 2. 撤销功能

提供撤销上一次操作的功能：

```typescript
const [history, setHistory] = useState([])

// 撤销
const undo = () => {
  const lastState = history[history.length - 1]
  setSelectedWindowType(lastState)
}
```

### 3. 快捷键支持

```typescript
// ESC键取消选择
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if (e.key === 'Escape' && selectedWindowType) {
      setSelectedWindowType(null)
      toast.info("已取消选择")
    }
  }
  window.addEventListener('keydown', handleKeyDown)
  return () => window.removeEventListener('keydown', handleKeyDown)
}, [selectedWindowType])
```

---

## 总结

### ✅ 实现的功能

1. **支持取消选择**
   - 再次点击已选窗型
   - 清空选择状态
   - 显示Toast提示

2. **保持原有行为**
   - 首次选择自动跳转
   - 更换窗型正常工作
   - 流程逻辑不变

3. **优化用户体验**
   - 更灵活的操作
   - 减少错误操作
   - 友好的反馈

### 🎯 用户价值

- 操作更自由
- 体验更友好
- 错误更少
- 效率更高

---

**版本**: v3.3.1  
**功能状态**: ✅ 已完成  
**更新时间**: 2025年11月6日

