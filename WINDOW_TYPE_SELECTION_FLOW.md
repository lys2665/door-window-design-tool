# 窗型选择流程优化

## 更新概述

优化步骤2"选择窗型"的交互流程，确保用户必须选择窗型才能继续，同时支持跳过中间步骤使用默认配置。

## 更新时间

2025年11月6日

---

## 功能说明

### 1. 强制窗型选择

#### 规则
- **步骤2是必选步骤**：用户必须在步骤2选择一个窗型
- **无法跳过步骤2**：未选择窗型时，无法进入步骤3、4、5
- **Toast提示**：尝试跳过时显示提示"请先选择窗型"

#### 实现
```typescript
const canNavigateToStage = (targetStage: number): boolean => {
  // 如果目标步骤 > 2（即步骤3及以后），需要检查是否选择了窗型
  if (targetStage > 2 && !selectedWindowType) {
    toast.info("请先选择窗型", {
      description: "请在步骤2选择一个窗型后再继续下一步",
    })
    return false
  }
  return true
}
```

### 2. 自动进入下一步

#### 规则
- **点击窗型卡片**：立即选中该窗型
- **自动跳转**：选中后自动进入步骤3（调细节）
- **流畅体验**：一键完成选择和跳转

#### 实现
```typescript
const handleWindowTypeSelect = (type: WindowType) => {
  setSelectedWindowType(type)
  // 自动进入下一步
  nextStage()
}
```

### 3. 支持跳过中间步骤

#### 规则
- **前提条件**：已选择窗型
- **允许跳过**：可以直接从步骤3跳到步骤5
- **使用默认配置**：跳过的步骤使用默认配置

#### 场景示例
```
步骤1（填信息）
  ↓
步骤2（选窗型）← 必须完成
  ↓
步骤3（调细节）← 可选，可以跳过
  ↓
步骤4（换样式）← 可选，可以跳过
  ↓
步骤5（看效果）
```

---

## 用户流程

### 标准流程（完整）

```
1. 进入步骤1：填信息
   用户填写基本信息
   ↓
   点击"下一步"
   ↓
2. 进入步骤2：选择窗型
   系统显示窗型网格
   ↓
   用户点击一个窗型卡片
   ↓
   系统自动进入步骤3
   ↓
3. 进入步骤3：调细节
   用户可以调整窗型细节
   ↓
   点击"下一步"
   ↓
4. 进入步骤4：换样式
   用户可以更换材质样式
   ↓
   点击"下一步"
   ↓
5. 进入步骤5：看效果
   查看报价和效果图
```

### 快速流程（跳过中间步骤）

```
1. 进入步骤1：填信息
   用户填写基本信息
   ↓
   点击"下一步"
   ↓
2. 进入步骤2：选择窗型
   系统显示窗型网格
   ↓
   用户点击一个窗型卡片
   ↓
   系统自动进入步骤3
   ↓
3. 用户点击步骤指示器上的"05 看效果"
   ↓
   系统验证：已选择窗型 ✓
   ↓
   直接跳转到步骤5
   ↓
5. 进入步骤5：看效果
   使用默认配置生成报价和效果图
```

### 错误流程（未选择窗型）

```
1. 进入步骤1：填信息
   用户填写基本信息
   ↓
   点击"下一步"
   ↓
2. 进入步骤2：选择窗型
   系统显示窗型网格和提示
   ↓
   用户未点击任何窗型
   ↓
   用户点击"下一步"按钮
   ↓
   系统检查：未选择窗型 ✗
   ↓
   显示Toast提示：
   "请先选择窗型
    请在步骤2选择一个窗型后再继续下一步"
   ↓
   停留在步骤2
```

---

## UI设计

### 步骤2界面布局

```
┌─────────────────────────────────────────────┐
│ 选择窗型                          已选: 001矩形│ ← 顶部栏
│ 总数: 48 / 48                                │
│                                             │
│ [全部] [简洁] [经济] ...  [展开]           │ ← 标签筛选
├─────────────────────────────────────────────┤
│                                             │
│ ╔═══════════════════════════════╗          │ ← 提示区（未选时）
│ ║ ⓘ 请选择一个窗型               ║          │
│ ║                               ║          │
│ ║ 点击下方窗型卡片即可选择，     ║          │
│ ║ 选择后将自动进入下一步。       ║          │
│ ╚═══════════════════════════════╝          │
│                                             │
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐          │ ← 窗型网格
│ │ 001 │ │ 002 │ │ 003 │ │ 004 │          │
│ │     │ │     │ │ ✓   │ │     │          │
│ └─────┘ └─────┘ └─────┘ └─────┘          │
│                                             │
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐          │
│ │ 005 │ │ 006 │ │ 007 │ │ 008 │          │
│ └─────┘ └─────┘ └─────┘ └─────┘          │
│                                             │
└─────────────────────────────────────────────┘
```

### 提示框设计（未选择窗型时）

```
┌─────────────────────────────────────────┐
│  ⓘ  请选择一个窗型                      │
│                                        │
│     点击下方窗型卡片即可选择，          │
│     选择后将自动进入下一步。            │
│     您也可以使用标签筛选来快速          │
│     找到合适的窗型。                    │
└─────────────────────────────────────────┘
```

**样式特点**：
- 蓝色背景（bg-blue-50）
- 蓝色边框（border-blue-200）
- 图标：LayoutGrid
- 圆形图标背景
- 清晰的标题和说明

### Toast 提示设计

```
┌─────────────────────────────────────────┐
│  ⓘ  请先选择窗型                    [×] │
│                                        │
│     请在步骤2选择一个窗型后再继续下一步 │
└─────────────────────────────────────────┘
```

**特点**：
- 信息类型（info）
- 蓝色渐变背景
- 2秒自动消失
- 可手动关闭

### 窗型卡片状态

#### 未选中状态
```
┌─────────────┐
│             │
│   ┌─────┐   │ ← 窗型结构图
│   │     │   │
│   └─────┘   │
│             │
│   001矩形   │ ← 窗型名称
│   1分格1    │ ← 窗型代码
└─────────────┘
  灰色边框
```

#### 悬停状态
```
┌─────────────┐
│             │
│   ┌─────┐   │
│   │     │   │
│   └─────┘   │
│             │
│   001矩形   │
│   1分格1    │
└─────────────┘
  蓝色边框
  阴影效果
```

#### 选中状态
```
┌─────────────┐
│         ✓   │ ← 选中标记
│   ┌─────┐   │
│   │     │   │
│   └─────┘   │
│             │
│   001矩形   │
│   1分格1    │
└─────────────┘
  蓝色边框（2px）
  强阴影效果
```

---

## 代码实现

### 1. 窗型选择验证

```typescript
// 验证是否可以进入指定步骤
const canNavigateToStage = (targetStage: number): boolean => {
  // 如果目标步骤 > 2（即步骤3及以后），需要检查是否选择了窗型
  if (targetStage > 2 && !selectedWindowType) {
    toast.info("请先选择窗型", {
      description: "请在步骤2选择一个窗型后再继续下一步",
    })
    return false
  }
  return true
}
```

### 2. 步骤导航函数

```typescript
// 下一步
const nextStage = () => {
  if (currentStage < designStages.length) {
    const targetStage = currentStage + 1
    if (canNavigateToStage(targetStage)) {
      setCurrentStage(targetStage)
    }
  }
}

// 跳转到指定步骤
const goToStage = (stageId: number) => {
  if (canNavigateToStage(stageId)) {
    setCurrentStage(stageId)
  }
}
```

### 3. 窗型选择处理

```typescript
// 选择窗型
const handleWindowTypeSelect = (type: WindowType) => {
  setSelectedWindowType(type)
  // 自动进入下一步
  nextStage()
}
```

### 4. 步骤完成状态检查

```typescript
// 检查当前步骤是否完成
const isStageCompleted = (stageId: number): boolean => {
  if (stageId === 2) {
    return !!selectedWindowType
  }
  // 其他步骤默认可以跳过（使用默认配置）
  return true
}
```

### 5. UI条件渲染

```tsx
{/* 未选中窗型提示 */}
{!selectedWindowType && (
  <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
    <div className="flex items-start gap-3">
      <div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
        <LayoutGrid className="w-5 h-5 text-blue-600" />
      </div>
      <div className="flex-1">
        <h3 className="text-sm font-semibold text-blue-900 mb-1">
          请选择一个窗型
        </h3>
        <p className="text-xs text-blue-700">
          点击下方窗型卡片即可选择，选择后将自动进入下一步。
          您也可以使用标签筛选来快速找到合适的窗型。
        </p>
      </div>
    </div>
  </div>
)}

{/* 已选中窗型提示 */}
{selectedWindowType && (
  <Badge variant="outline" className="gap-2">
    <span className="text-xs">已选:</span>
    <span className="font-semibold">{selectedWindowType.name}</span>
  </Badge>
)}
```

---

## 交互细节

### 1. 点击窗型卡片

```
用户操作：点击窗型卡片
    ↓
系统响应：
  1. 更新 selectedWindowType 状态
  2. 卡片显示选中样式（蓝色边框 + ✓ 标记）
  3. 顶部显示"已选"徽章
  4. 自动调用 nextStage()
  5. 切换到步骤3
    ↓
视觉反馈：
  - 卡片缩放动画（scale-98）
  - 平滑的页面过渡
  - 步骤指示器更新
```

### 2. 点击"下一步"按钮（未选窗型）

```
用户操作：在步骤2点击"下一步"
    ↓
系统检查：selectedWindowType === null
    ↓
系统响应：
  1. 调用 canNavigateToStage(3)
  2. 返回 false
  3. 显示 Toast 提示
  4. 保持在步骤2
    ↓
视觉反馈：
  - Toast 从顶部滑入
  - 蓝色信息类 Toast
  - 2秒后自动消失
```

### 3. 点击步骤指示器（已选窗型）

```
用户操作：点击步骤指示器上的"05 看效果"
    ↓
系统检查：selectedWindowType !== null ✓
    ↓
系统响应：
  1. 调用 goToStage(5)
  2. 验证通过
  3. 直接跳转到步骤5
    ↓
视觉反馈：
  - 步骤指示器高亮步骤5
  - 页面切换到步骤5内容
  - 使用默认配置生成效果
```

### 4. 点击步骤指示器（未选窗型）

```
用户操作：点击步骤指示器上的"03 调细节"
    ↓
系统检查：selectedWindowType === null ✗
    ↓
系统响应：
  1. 调用 goToStage(3)
  2. 验证失败
  3. 显示 Toast 提示
  4. 保持在当前步骤
    ↓
视觉反馈：
  - Toast 提示
  - 步骤指示器不变化
```

---

## 边界情况处理

### 1. 从步骤1返回步骤2

**场景**：用户在步骤2选择了窗型，自动进入步骤3，然后点击"上一步"返回

**处理**：
```typescript
const prevStage = () => {
  if (currentStage > 1) {
    setCurrentStage(currentStage - 1)
  }
}
```

**结果**：
- 允许返回步骤2
- 保留之前选择的窗型
- 显示"已选"徽章
- 可以重新选择窗型

### 2. 更换窗型

**场景**：用户想要更换已选择的窗型

**操作流程**：
```
1. 返回步骤2（或直接点击步骤2）
   ↓
2. 点击新的窗型卡片
   ↓
3. 旧窗型取消选中
   ↓
4. 新窗型被选中
   ↓
5. 自动进入步骤3
```

### 3. 快速预览

**场景**：用户想快速查看不同窗型的效果

**操作流程**：
```
步骤2: 点击窗型A → 自动进入步骤3
  ↓
点击"上一步" → 返回步骤2
  ↓
点击窗型B → 自动进入步骤3（新窗型）
  ↓
点击"上一步" → 返回步骤2
  ↓
点击窗型C → 自动进入步骤3（新窗型）
```

### 4. 直接跳到最后

**场景**：熟悉的用户想快速完成流程

**操作流程**：
```
步骤1: 填写信息 → 点击"下一步"
  ↓
步骤2: 选择窗型 → 自动进入步骤3
  ↓
点击步骤指示器"05 看效果"
  ↓
系统验证：已选窗型 ✓
  ↓
直接跳转到步骤5
  ↓
使用默认配置生成结果
```

---

## 测试场景

### 功能测试

- [ ] **未选窗型时点击下一步**
  - 显示Toast提示
  - 保持在步骤2
  - Toast 2秒后消失

- [ ] **未选窗型时点击步骤3/4/5**
  - 显示Toast提示
  - 保持在当前步骤
  - 步骤指示器不变化

- [ ] **选择窗型后自动跳转**
  - 点击窗型卡片
  - 卡片显示选中状态
  - 自动进入步骤3

- [ ] **已选窗型时跳过中间步骤**
  - 从步骤3点击步骤5
  - 直接跳转成功
  - 使用默认配置

- [ ] **更换窗型**
  - 返回步骤2
  - 点击新窗型
  - 旧窗型取消选中
  - 新窗型被选中
  - 自动进入步骤3

### UI测试

- [ ] **提示框显示正确**
  - 未选窗型时显示蓝色提示框
  - 已选窗型时隐藏提示框
  - 显示"已选"徽章

- [ ] **窗型卡片状态**
  - 未选中：灰色边框
  - 悬停：蓝色边框 + 阴影
  - 选中：蓝色边框（2px）+ ✓ 标记

- [ ] **Toast样式**
  - 蓝色渐变背景
  - 顶部居中显示
  - 有关闭按钮
  - 2秒自动消失

### 响应式测试

- [ ] **桌面端**
  - 窗型网格：6列
  - 提示框正常显示
  - Toast位置正确

- [ ] **平板端**
  - 窗型网格：3-4列
  - 布局适配
  - 交互流畅

- [ ] **移动端**
  - 窗型网格：2列
  - 提示框自适应
  - 触摸反馈正常

---

## 用户体验优势

### 1. 强制引导

```
✓ 确保用户不会遗漏关键步骤
✓ 减少后续错误和困惑
✓ 提供清晰的流程指引
```

### 2. 快速完成

```
✓ 点击窗型立即进入下一步
✓ 减少额外的点击操作
✓ 流程更加流畅
```

### 3. 灵活跳过

```
✓ 支持快速预览最终效果
✓ 适合熟悉流程的用户
✓ 提高操作效率
```

### 4. 清晰反馈

```
✓ 实时显示选中状态
✓ Toast提示明确
✓ 视觉反馈丰富
```

---

## 技术亮点

### 1. 状态驱动

```typescript
// 单一数据源
const [selectedWindowType, setSelectedWindowType] = useState(null)

// 派生状态
const hasSelectedWindowType = !!selectedWindowType
const canProceed = hasSelectedWindowType
```

### 2. 统一验证

```typescript
// 所有导航都经过验证
const nextStage = () => {
  if (canNavigateToStage(currentStage + 1)) {
    setCurrentStage(currentStage + 1)
  }
}

const goToStage = (stageId: number) => {
  if (canNavigateToStage(stageId)) {
    setCurrentStage(stageId)
  }
}
```

### 3. 自动化流程

```typescript
// 选择后自动跳转
const handleWindowTypeSelect = (type) => {
  setSelectedWindowType(type)
  nextStage() // 自动化
}
```

### 4. 友好提示

```typescript
// 清晰的用户提示
toast.info("请先选择窗型", {
  description: "请在步骤2选择一个窗型后再继续下一步",
})
```

---

## 相关文件

### 修改的文件

1. **app/design/page.tsx**
   - 更新 `canNavigateToStage` 函数
   - 添加 `isStageCompleted` 函数
   - 优化 Toast 提示文案
   - 添加步骤2提示框

### 未修改的文件

- 其他页面和组件保持不变
- 窗型数据保持不变

---

## 总结

### ✅ 实现的功能

1. **强制窗型选择**
   - 步骤2是必选步骤
   - 未选窗型无法继续
   - Toast提示清晰

2. **自动进入下一步**
   - 点击窗型立即选中
   - 自动跳转到步骤3
   - 流程流畅

3. **支持跳过中间步骤**
   - 已选窗型后可直接跳到步骤5
   - 使用默认配置
   - 提高效率

4. **视觉提示优化**
   - 蓝色提示框
   - "已选"徽章
   - Toast通知

### 🎯 用户价值

- 流程更清晰
- 操作更快捷
- 体验更友好
- 错误更少

---

**版本**: v3.3.0  
**功能状态**: ✅ 已完成  
**更新时间**: 2025年11月6日

